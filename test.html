'use strict';

const elasticsearch = require('elasticsearch'),
  qaClient = new elasticsearch.Client({
    host: 'elastic.prd.aws.nymetro.com:9200'
  }),
  stgClient = new elasticsearch.Client({
    host: 'elastic.stg.aws.nymetro.com:9200' // TODO: Set as env var
    // log: 'trace'
  }),
  ElasticsearchScrollStream = require('elasticsearch-scroll-stream'),
  stripTags = require('striptags'),
  _ = require('highland'),
  _map = require('lodash/map'),
  _compact = require('lodash/compact'),
  _omit = require('lodash/omit'),
  bigQuery = require('./big-query'),
  _pick = require('lodash/pick'),
  _keys = require('lodash/keys'),
  _pickBy = require('lodash/pickBy'),
  _filter = require('lodash/filter'),
  request = require('request'),
  JSONStream = require('JSONStream'),
  btoa = require('btoa');

/**
 * Resolves data refs

/**
 * Resolves data refs
 *
 * @param {String} url
 * @returns {Object} request
 */
function resolveRef(url) {
  console.log('what is url', url);
  return request({
    url: `${url}.json`,
    timeout: 120000,
    headers: {
      Host: 'nymag.com',
      'X-forwarded-host': 'nymag.com'
    },
    json:true
  }, function (error, response, body) {
  console.log('error:', error); // Print the error if one occurred
  console.log('statusCode:', response && response.statusCode); // Print the response status code if a response was received
  //console.log('body:', body); // Print the HTML for the Google homepage.
  });
}




/**
 * For components with description fields, resolve properties
 *
 * @param {Object} entry Object with resolved data
 * @param {String} comp Component
 * @returns {Object}
 */
function checkRef(entry, comp) {
  if (entry && entry._ref) {
  var ref = entry._ref.indexOf(`components/${comp}`) !== -1,
    relatedStory = _pick(entry, ['plaintextTitle', 'title', 'content']);

    relatedStory.content = _map(relatedStory.content, obj => _pick(obj, '_ref'));

    return ref ? _pick(entry, ['text', '_version']) : relatedStory;
  }
  
  return entry;
}


/**
 * Resolve object values, e.g. [{text:tag}{text:tag}] becomes [tag, tag]
 * @param {[{}]} items
 * @returns {Array}
 */
function resolveObj(items) {
  return items.reduce((arr, item) => {
      return arr.concat(stripTags(item.text));
  }, []);
}


/**
 * Bulk inserts documents into an Elasticsearch index
 *
 * @param {String} index Elasticsearch index
 * @param {String} type Elasticsearch type
 * @param {String} id Elasticsearch document _id
 * @param {Object} doc Elasticsearch document
 * @returns {Object} doc
 */
function insert(index, type, id, doc) {
  //console.log('what is doc', doc);
  return stgClient.bulk({
    body: [
      { index:  { _index: index, _type: type, _id: id  } },
      doc,
    ]
  }, function (err, resp) {
    console.log('what is the error here', err);
    console.log('resp', resp.errors);
  });
}


/**
 * Get back documents from Elasticsearch based on a provided field name
 * Pass documents through the classifier
 *
 * @param {Object} module
 * @param {String} argv Arguments provided
 */
function get(module, argv) {
  const //split = argv.from.split('.'),
    //feature = module[argv.fe],
    //index = split[0],
    //field = argv.f,
    pageSize = '200',
    //type = split[1],
    es_stream = new ElasticsearchScrollStream(qaClient, {
      index: 'published-articles',
      type: '_doc',
      scroll: '5s',
      size: pageSize,
      body: {      
        query: {
          bool : {
            filter: {
              prefix: {canonicalUrl: 'http://nymag.com/strategist'}
            },
            must: [{
              range: {
                date: {
                  gt: "01/01/2017",
                  lte: "28/02/2017",
                  format: "dd/MM/yyyy||yyyy"
                }
              }
            }
            ]
          }
        },
        sort: {
          "date": "desc"
        }       
      }
    }, ['_id']);


  _(es_stream)
    .through(JSONStream.parse())
    .ratelimit(1, 1600)
    .flatMap(function (item) {
      var id = item['_id'],
        url = id.replace('nymag.com', 'http://172.24.17.157');

      
      return _(resolveRef(url))
      //return _(request({url: `${url}.json`, json:true, timeout: 40000,headers: {Host: 'nymag.com','X-forwarded-host': 'nymag.com'}}))
        .through(JSONStream.parse())
        .each(function (entry) {
          console.log("THIS IS AN ENTRY!")
          let entryUri = item['pageUri'],
            entryContentChannel = entry.contentChannel,
            product = _map(entry.content, (function (obj){
            if (obj._ref.indexOf("components/product/") !== -1) {
              let data = {
                contentChannel: entryContentChannel || '',
                pageUri: entryUri || '',
                name: obj.name || '',
                productId: obj.productId || '',
                productRef: obj._ref || '',
                priceLow: obj.priceLow || '',
                buyUrl: obj.buyUrl || '',
                buyUrlHistory: obj.buyUrlHistory || [],
                suppressSkimLinks: obj.suppressSkimLinks || '',
                salePrice: obj.salePrice || '',
                canonicalUrl: obj.canonicalUrl || ''
              };
              //return bigQuery.insert(data);
            } else {
              console.log("no products here!", entryUri);
            }
            return entry;
          }));

        });
    })
    .each(function (item) {
      console.log('DONE!', item);
    });
}

module.exports.get = get;

